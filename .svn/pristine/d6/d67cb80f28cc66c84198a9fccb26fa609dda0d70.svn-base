package com.spanel.dao;

import com.spanel.beans.File;

import java.sql.Date;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDate;

import static com.spanel.dao.DAOUtilitary.initPreparedStatement;
import static com.spanel.dao.DAOUtilitary.silentClose;

/**
 * Created by koria on 30/12/2016.
 */
public class FileDAOlmpl implements FileDao {
    private DAOFactory daoFactory;
    public FileDAOlmpl(DAOFactory daoFactory){
        this.daoFactory = daoFactory;
    }
    private static String SQL_INSERT="INSERT INTO files(author_id,class_id,name,path,type,description,date) VALUES(?,?,?,?,?,?,?)";
    private static String SQL_FIND_SCHEDULE_BY_PATH ="SELECT id,author_id,class_id,name,path,type,description,date FROM files WHERE id IN(SELECT MAX(id) FROM files WHERE type=\"schedule\")  ";
    private static String SQL_FIND_PROFILE_PICTURE ="SELECT id,author_id,class_id,name,path,type,description,date FROM files WHERE  type=\"profilePicture\"";
    private static String SQL_FIND_OLD_VERSION ="SELECT MAX(id),author_id,class_id,name,path,type,description,date FROM files WHERE id <(SELECT MAX(id) FROM files WHERE type=\"schedule\")";
    @Override
    public void create(File file) throws DAOException {
        java.sql.Connection connection = null;
        java.sql.PreparedStatement preparedStatement = null;
        ResultSet AutoGeneratedValue = null;
        try {
            connection = daoFactory.getConnection();
            preparedStatement = initPreparedStatement(connection, SQL_INSERT, true, file.getAuthorId(), file.getClassId(), file.getName(), file.getPath(), file.getType(), file.getDescription(), file.getDate());
            int status = preparedStatement.executeUpdate();
            if (status == 0) {
                throw new DAOException("Failed to create file in database,No id auto generated value  ");
            }
            AutoGeneratedValue = preparedStatement.getGeneratedKeys();
            if (AutoGeneratedValue.next()) {
                file.setId(AutoGeneratedValue.getLong(1));
            } else {
                throw new DAOException("Failed to create file in database,No id auto generated value  ");

            }
        } catch (SQLException e) {
            throw new DAOException(e);
        } finally {
            silentClose(preparedStatement);
            silentClose(AutoGeneratedValue);
            silentClose(connection);
        }
    }



    @Override
    public void delete(Long id) throws DAOException {

    }

    @Override
    public File find(Long id) throws DAOException {
        return null;
    }

    @Override
    public File findOldSchedule() throws DAOException {
        java.sql.Connection connection =null;
        java.sql.PreparedStatement preparedStatement =null;
        ResultSet resultSet = null ;
        File file = null;
        try {
            connection = daoFactory.getConnection();
            preparedStatement = initPreparedStatement(connection,SQL_FIND_OLD_VERSION,false);
            resultSet = preparedStatement.executeQuery();
            if(resultSet.next()){
                file = map(resultSet);
            }
        }catch (SQLException e){
            throw new DAOException(e);
        }
        return file;
    }
    @Override
    public File findProfilePicture() throws DAOException {
        java.sql.Connection connection =null;
        java.sql.PreparedStatement preparedStatement =null;
        ResultSet resultSet = null ;
        File file = null;
        try {
            connection = daoFactory.getConnection();
            preparedStatement = initPreparedStatement(connection,SQL_FIND_PROFILE_PICTURE,false);
            resultSet = preparedStatement.executeQuery();
            if(resultSet.next()){
                file = map(resultSet);
            }
        }catch (SQLException e){
            throw new DAOException(e);
        }
        return file;
    }

    @Override
    public File findByMaxId() throws DAOException {
        java.sql.Connection connection =null;
        java.sql.PreparedStatement preparedStatement =null;
        ResultSet resultSet = null ;
        File file = null;
        try {
            connection = daoFactory.getConnection();
            preparedStatement = initPreparedStatement(connection,SQL_FIND_SCHEDULE_BY_PATH,false);
            resultSet = preparedStatement.executeQuery();
            if(resultSet.next()){
              file = map(resultSet);
            }else {
                file = new File();
                file.setName("default");
                file.setClassId(Long.parseLong("1"));
                file.setAuthorId(Long.parseLong("1"));
                file.setPath("assets/uploads/img/b.jpg");
                file.setType("schedule");
                file.setDate(Date.valueOf(LocalDate.now()));
                file.setDescription("");

            }
        }catch (SQLException e){
            throw new DAOException(e);
        }
        return file;
    }
    public static File map( ResultSet resultSet ) throws SQLException {
        File file= new File();
        file.setId( resultSet.getLong( 1 ) );
        file.setAuthorId(resultSet.getLong(2));
        file.setClassId(resultSet.getLong(3));
        file.setName( resultSet.getString( 4) );
        file.setPath(resultSet.getString(5));
        file.setType(resultSet.getString(6));
        file.setDescription(resultSet.getString(7));
        file.setDate(resultSet.getDate(8));

        return file;
    }
}
